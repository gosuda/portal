<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Portal Proxy Gateway</title>
    </head>
    <body>
        <h1>Portal Proxy Gateway</h1>
        <hr/>
        <p id="status">Please wait for the service worker to register...</p>
        <script>
            async function registerServiceWorker() {
                try {
                    if (!('serviceWorker'in navigator)) {
                        throw new Error('This browser does not support Service Worker.');
                    }

                    showStatus('Registering Service Worker...', 'loading');

                    // Register service worker
                    const registration = await navigator.serviceWorker.register('/service-worker.js', {
                        scope: '/'
                    });
                    showStatus('Service Worker registered successfully, Wait a moment...', 'success');
                } catch (error) {
                    showStatus('Service Worker registration failed: ' + error.message, 'error');
                }

                const reloadFn = async () => {
                    const resp = await fetch('/e8c2c70c-ec4a-40b2-b8af-d5638264f831');
                    const text = await resp.text();
                    if (text === 'ACK-e8c2c70c-ec4a-40b2-b8af-d5638264f831') {
                        showStatus('Service Worker is ready.', 'success');
                        window.location.reload();
                    } else if (text === 'NAK-e8c2c70c-ec4a-40b2-b8af-d5638264f831'){
                        setTimeout(reloadFn, 100);
                    } else {
                        showStatus('Something went wrong.', 'error');
                        setTimeout(()=>{
                            window.location.reload();
                        }, 1000);
                    }
                }
                reloadFn();
            }

            function showStatus(message, status) {
                const statusElement = document.getElementById('status');
                statusElement.textContent = message;
                statusElement.className = status;
            }

            registerServiceWorker();
        </script>
    </body>
</html>
