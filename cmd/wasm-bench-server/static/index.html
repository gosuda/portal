<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>WASM Benchmark</title>
    <style>
        body { font-family: sans-serif; background-color: #f0f0f0; color: #333; }
        #container { max-width: 800px; margin: 40px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button { font-size: 16px; padding: 10px 20px; cursor: pointer; }
        pre { background-color: #eee; padding: 10px; border-radius: 4px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="container">
        <h1>Portal WASM Performance Benchmark</h1>
        <p>This page measures the performance of cryptographic operations (credential generation) running inside the compiled WebAssembly module.</p>
        <button id="run-benchmark">Run Benchmark (100 iterations)</button>
        <h2>Results</h2>
        <pre id="results">Click the button to start the benchmark.</pre>
    </div>

    <script src="/wasm/wasm_exec.js"></script>
    <script>
        const resultsLog = document.getElementById('results');
        const runButton = document.getElementById('run-benchmark');

        function log(message) {
            console.log(message);
            resultsLog.textContent = message + '\n' + resultsLog.textContent;
        }

        if (!WebAssembly.instantiateStreaming) {
            WebAssembly.instantiateStreaming = async (resp, importObject) => {
                const source = await (await resp).arrayBuffer();
                return await WebAssembly.instantiate(source, importObject);
            };
        }

        const go = new Go();

        window.wasmIsReady = () => {
            log('Go program started. Ready to benchmark.');
            runButton.disabled = false;
        };

        async function loadAndRunWasm() {
            try {
                log('Fetching WASM filename...');
                const response = await fetch('/api/wasm-file');
                if (!response.ok) {
                    throw new Error(`API request failed: ${response.statusText}`);
                }
                const data = await response.json();
                const wasmFile = data.fileName;

                if (!wasmFile) {
                    throw new Error('WASM filename is empty.');
                }

                log(`Loading ${wasmFile}...`);
                const wasmModule = await WebAssembly.instantiateStreaming(fetch(`/wasm/${wasmFile}`), go.importObject);
                
                log('WASM module loaded successfully.');
                go.run(wasmModule.instance);

            } catch (err) {
                log(`Failed to load WASM: ${err}`);
                console.error(err);
            }
        }

        loadAndRunWasm();

        runButton.disabled = true;
        runButton.onclick = () => {
            const iterations = 100;
            log(`Running benchmark with ${iterations} iterations...`);
            runButton.disabled = true;

            setTimeout(() => {
                try {
                    const duration = benchmarkCrypto(iterations);
                    const opsPerSecond = (iterations / (duration / 1000)).toFixed(2);
                    log(`Benchmark finished.`);
                    log(`Total time: ${duration} ms`);
                    log(`Operations per second: ${opsPerSecond}`);
                } catch (e) {
                    log('Benchmark failed: ' + e);
                } finally {
                    runButton.disabled = false;
                }
            }, 10); // Use timeout to allow UI to update
        };

    </script>
</body>
</html>
