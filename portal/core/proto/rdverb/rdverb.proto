syntax = "proto3";

package rdverb;

import "portal/core/proto/rdsec/rdsec.proto";

option go_package = "gosuda.org/portal/portal/core/proto/rdverb;rdverb";

enum PacketType {
  PACKET_TYPE_RELAY_INFO_REQUEST = 0;
  PACKET_TYPE_RELAY_INFO_RESPONSE = 1;

  PACKET_TYPE_LEASE_UPDATE_REQUEST = 2; // Authenticated
  PACKET_TYPE_LEASE_UPDATE_RESPONSE = 3;

  PACKET_TYPE_LEASE_DELETE_REQUEST = 4; // Authenticated
  PACKET_TYPE_LEASE_DELETE_RESPONSE = 5;

  PACKET_TYPE_CONNECTION_REQUEST = 6;
  PACKET_TYPE_CONNECTION_RESPONSE = 7;

  PACKET_TYPE_UDP_REGISTER_REQUEST = 8; // Authenticated - Register UDP endpoint
  PACKET_TYPE_UDP_REGISTER_RESPONSE = 9;
}

enum ResponseCode {
  RESPONSE_CODE_UNKNOWN = 0;
  RESPONSE_CODE_ACCEPTED = 1;

  RESPONSE_CODE_INVALID_EXPIRES = 2;
  RESPONSE_CODE_INVALID_IDENTITY = 3;
  RESPONSE_CODE_INVALID_NAME = 4;
  RESPONSE_CODE_INVALID_ALPN = 5;

  RESPONSE_CODE_REJECTED = 6;
}

message Packet {
  PacketType type = 1;
  bytes payload = 2;
}

message RelayInfo {
  rdsec.Identity identity = 1;
  repeated string address = 2;
  repeated Lease leases = 3;
}

message RelayInfoRequest {}

message RelayInfoResponse {
  RelayInfo relay_info = 1;
}

enum Protocol {
  PROTOCOL_TCP = 0;  // TCP-based (yamux streams)
  PROTOCOL_UDP = 1;  // UDP-based (packet relay)
  PROTOCOL_BOTH = 2; // Both TCP and UDP
}

message Lease {
  rdsec.Identity identity = 1;
  int64 expires = 2;
  string name = 3;
  repeated string alpn = 4;
  Protocol protocol = 5; // Protocol type for this lease
}

message LeaseUpdateRequest {
  Lease lease = 1;
  bytes nonce = 2;
  int64 timestamp = 3;
}

message LeaseUpdateResponse {
  ResponseCode code = 1;
}

message LeaseDeleteRequest {
  rdsec.Identity identity = 1;
  bytes nonce = 2;
  int64 timestamp = 3;
}

message LeaseDeleteResponse {
  ResponseCode code = 1;
}

message ConnectionRequest {
  string lease_id = 1;
  rdsec.Identity client_identity = 2;
}

message ConnectionResponse {
  ResponseCode code = 1;
}

message UDPRegisterRequest {
  string lease_id = 1;        // Lease ID to register UDP for
  bytes nonce = 2;            // Random nonce for replay protection
  int64 timestamp = 3;        // Timestamp for message freshness
}

message UDPRegisterResponse {
  ResponseCode code = 1;
  int32 udp_port = 2;        // UDP port assigned by relay server
  string session_token = 3;   // Session token for UDP packets
}
